
---
title: "Comparison of operating model fits"
subtitle: "ABT-MSE"
author: "Tom Carruthers"
date:  "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true 
---


<style type="text/css">

body{ /* Normal  */
   font-size: 16px;
}
td {  /* Table  */
   font-size: 14px;
}
title { /* title */
 font-size: 26px;
}
h1 { /* Header 1 */
 font-size: 24px;
 color: DarkBlue;
}
h2 { /* Header 2 */
 font-size: 21px;
 color: DarkBlue;
}
h3 { /* Header 3 */
 font-size: 19px;
 color: DarkBlue;
}
code.r{ /* Code block */
  font-size: 16px;
}
pre { /* Code block */
  font-size: 16px
}
</style>

# Introduction / notes

This is a short document intended to highlight how well operating models fit the data given their various assumptions / parameterizations. 

Note that operating models with recruitment level 1 and 3 are identical in their historical recruitment and are therefore identical in their model fitting. Only levels 1 and 2 are presented here.


# OM design 

## Factor 1: Future Recruitment 

```{r OMdesign1, results='asis',echo=FALSE,size="small"}
T1<-data.frame(Design$all_lnams[[1]])
names(T1)<-""
kable(T1,format='markdown')
#("normalsize", "tiny", "scriptsize", "footnotesize", "small", "large", "Large", "LARGE", "huge", "Huge
```

## Factor 2: Current Abundance 

```{r OMdesign2, results='asis',echo=FALSE}
T1<-data.frame(Design$all_lnams[[2]])
names(T1)<-""
kable(T1,format='markdown')

```

## Factor 3: Natural Mortality / Maturity

```{r OMdesign3, results='asis',echo=FALSE}
T1<-data.frame(Design$all_lnams[[3]])
names(T1)<-""
kable(T1,format='markdown')

```


# Comparison of global likelihoods

```{r loadsecret,echo=F,warning=F,error=F,message=F}

outs<-OMIs<-new('list')
nOMs<-length(OMdirs)

sfInit(parallel=T,cpus=8)
M3read<-ABTMSE::M3read
sfExport("M3read")

outread<-function(x,OMdirs)M3read(OMdirs[x])
OMIread<-function(x,OMdirs){
  load(paste0(OMdirs[x],"/OMI"))
  return(OMI)
}

outs<-sfLapply(1:nOMs,outread,OMdirs=OMdirs)
OMIs<-sfLapply(1:nOMs,OMIread,OMdirs=OMdirs)

cond<-!grepl("3",OMcodes)
nOMs<-sum(cond)

OMcodes<-OMcodes[cond]

tabs<-LHtabs(outs,OMIs,OMnos=c(1,2,4,5,7,8,10,11),OMnams=OMcodes)  
LHs<-tabs$LHs
LHsU<-tabs$LHsU

colr<-function(x,ncol=1000,cond=NA){
  if(!is.na(cond[1]))x[cond]<-mean(x[!cond])
  if(all(x==x[1])){
    tempcol<-rep('black',length(x))
  }else{
    xconv<-1-((x-min(x,na.rm=T))/(max(x,na.rm=T)-min(x,na.rm=T)))
    tempcol<-hsv(h=xconv*0.33)
    if(!is.na(cond[1]))tempcol[cond]="black"
  }
  tempcol
}

tabber<-function(nam,LHs,OMcodes){

  tab=NULL
  colno<-match(nam,names(LHs))

  f1s<-c(1,2)
  f2s<-c("A","B")

  for(f1 in 1:2){

    cond1<-grepl(f1s[f1],LHs[,2])

    for(f2 in 1:3){

      cond2<-grepl(f2s[f2],LHs[,2])
      got<-LHs[cond1&cond2,colno]
      tab<-cbind(tab,got)

    }

  }

  tab<-as.data.frame(tab)
  names(tab) <-     c("A","B","A_","B_")
  row.names(tab) <- c("I","II")
  tab

}

tabber2<-function(nam,LHs,OMcodes){

  tab=NULL
  colno<-match(nam,names(LHs))

  f1s<-c(1,2)
  f2s<-c("A","B")

  for(f1 in 1:2){

    cond1<-grepl(f1s[f1],LHs[,2])

    for(f2 in 1:2){

      cond2<-grepl(f2s[f2],LHs[,2])
      got<-LHs[cond1&cond2,colno]
      tab<-cbind(tab,got)

    }

  }

  tab<-as.data.frame(tab)
  names(tab) <-     c("A","B","A_","B_")
  row.names(tab) <- c("I","II")
  tab

}

fortab<-function(tab,nam,cond,isrel=T){

  cols<-matrix(colr(unlist(tab),cond=cond),nrow=2)
  dynheader<-c(1,6)
  names(dynheader)<-c(" ",nam)
  if(isrel)tab<-round(tab-min(tab),1)

  tab%>%
  mutate(
    F3 = row.names(.),
    A=cell_spec(A,"html",color=cols[,1],bold=T),
    B=cell_spec(B,"html",color=cols[,2],bold=T),
    A_=cell_spec(A_,"html",color=cols[,4],bold=T),
    B_=cell_spec(B_,"html",color=cols[,5],bold=T),
  )%>%
  select(F3,A, B,A_,B_) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F) %>%
  add_header_above(c(" "=1,"1"=3,"2"=3)) 

}

fortab2<-function(tab,nam,cond,isrel=T){

  cols<-matrix(colr(unlist(tab),cond=cond),nrow=2)
  dynheader<-c(1,4)
  names(dynheader)<-c(" ",nam)
  if(isrel)tab<-round(tab-min(tab),1)

  tab%>%
  mutate(
    F3 = row.names(.),
    A=cell_spec(A,"html",color=cols[,1],bold=T),
    B=cell_spec(B,"html",color=cols[,2],bold=T),
    A_=cell_spec(A_,"html",color=cols[,3],bold=T),
    B_=cell_spec(B_,"html",color=cols[,4],bold=T)
    )%>%
  select(F3,A, B,A_,B_) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F) %>%
  add_header_above(c(" "=1,"1"=2,"2"=2)) 

}


LHs2<-LHs[order(LHs[,17]),]
cond<-LHs2[,17]>(mean(LHs2[,17])*3)

#for(i in 3:18)LHs2[,i]<-round(LHs2[,i]-LHs2[1,i],1)
  
library(dplyr)
library(kableExtra)

```

These are weighted negative log-likelihoods. The total global objective TOT is presented here minus the new penalties in levels B and C for abundance (SSB and Dep that are colored black). Color coding is by column. Rows with all black values depict models that did not converge. The table in ascending order of global negative log-likelihood (TOT) (ie decreasing fit down the rows). The likelihoods are expressed as differences from the best fit model (top row). 


```{r TotLHF, fig.width=9, fig.height=9,echo=FALSE}

LHs2%>%
  mutate(
    OM=cell_spec(OM,"html",bold=T),
    Code=cell_spec(Code,"html",bold=T),
    Cat=cell_spec(Cat,"html",color=colr(LHs2$Cat,cond=cond),bold=T),
    CR=cell_spec(CR,"html",color=colr(LHs2$CR,cond=cond),bold=T),
    Comp=cell_spec(Comp,"html",color=colr(LHs2$Comp,cond=cond),bold=T),
    SOOm=cell_spec(SOOm,"html",color=colr(LHs2$SOOm,cond=cond),bold=T),
    SOOg=cell_spec(SOOg,"html",color=colr(LHs2$SOOg,cond=cond),bold=T),
    Tag=cell_spec(Tag,"html",color=colr(LHs2$Tag,cond=cond),bold=T),
    Rec=cell_spec(Rec,"html",color=colr(LHs2$Rec,cond=cond),bold=T),
    Mov=cell_spec(Mov,"html",color=colr(LHs2$Mov,cond=cond),bold=T),
    Sel=cell_spec(Sel,"html",color=colr(LHs2$Sel,cond=cond),bold=T),
    SRA=cell_spec(SRA,"html",color=colr(LHs2$SRA,cond=cond),bold=T),
    R0diff=cell_spec(R0diff,"html",color=colr(LHs2$R0diff,cond=cond),bold=T),
    MI=cell_spec(MI,"html",color=colr(LHs2$MI,cond=cond),bold=T),
    TOT_nP=cell_spec(TOT_nP,"html",color=colr(LHs2$TOT_nP,cond=cond),bold=T),
    TOT=cell_spec(TOT,"html",color=colr(LHs2$TOT,cond=cond),bold=T)

  )%>%
  select(OM, Code,Cat,CR,Comp,SOOm,SOOg,Tag,Rec,Mov,Sel,SRA,R0diff,MI,TOT_nP,TOT) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped")#, full_width = T) 


```
Cat = catch data by fleet, quarter and area. CR = the fishery dependent catch rate (CPUE) indices, Surv = fishery-independent survey indices, Comp = length composition data, SOOm = stock of origin microchemistry data, SOOg = stock of origin genetics, Tag = Electronic tagging data, Rec = prior on recruitment deviations, Mov = prior on movement parameters, Sel = prior on size selectivity parameters, SRA = penalty incurred when catches exceed F=1 catches in the stock reduction analysis phase (1864-1964), MI = a prior on similarity to the 'Master Index' that predicts F by year, area, season and fleet, R0diff = a prior on the difference in R0 estimated in two-phase recruitment models (recruitment level 1 and 3), TOT_nP = total global objective function without priors, TOT = total global objective function.  



# Component likelihoods 

The following tables are to help identify what operating model factors affect fit or lack thereof. The values in these tables are relative to the best fit to these data. Values colored black correspond with models that did not converge. 

## Total likelihood 

```{r TOT, fig.width=7, fig.height=9,echo=FALSE}

  tab<-tabber2("TOT",LHs,OMcodes)
  cond<-unlist(tab)>mean(unlist(tab))*3
  fortab2(tab,"TOT",cond)
  

```

## Total likelihood (no priors)

```{r TOT_NP, fig.width=7, fig.height=9,echo=FALSE}

  tab<-tabber2("TOT_nP",LHs,OMcodes)
  cond<-unlist(tab)>mean(unlist(tab))*3
  fortab2(tab,"TOT_nP",cond)
  

```

## Catch 

```{r Catch, fig.width=7, fig.height=9,echo=FALSE}

  tab<-tabber2("Cat",LHs,OMcodes)
  fortab2(tab,"Cat",cond)
  

```

## Fishery dependent CPUE indices 

```{r CPUE, fig.width=7, fig.height=9,echo=FALSE}

  tab<-tabber2("CR",LHs,OMcodes)
  fortab2(tab,"CR",cond)
  

```

## Fishery Independent indices 

```{r Survey, fig.width=7, fig.height=9,echo=FALSE}

  tab<-tabber2("Surv",LHs,OMcodes)
  fortab2(tab,"Surv",cond)
  

```

## Length composition 

```{r Lcomp, fig.width=7, fig.height=9,echo=FALSE}

  tab<-tabber2("Comp",LHs,OMcodes)
  fortab2(tab,"Comp",cond)
  

```

## Stock of origin microchemistry 

```{r SOOm, fig.width=7, fig.height=9,echo=FALSE}

  tab<-tabber2("SOOm",LHs,OMcodes)
  fortab2(tab,"SOOm",cond)
  

```


## Stock of origin genetics 

```{r SOOg, fig.width=7, fig.height=9,echo=FALSE}

  tab<-tabber2("SOOg",LHs,OMcodes)
  fortab2(tab,"SOOg",cond)
  

```

## Electronic tagging 

```{r PSAT, fig.width=7, fig.height=9,echo=FALSE}

  tab<-tabber2("Tag",LHs,OMcodes)
  fortab2(tab,"Tag",cond)
  

```




