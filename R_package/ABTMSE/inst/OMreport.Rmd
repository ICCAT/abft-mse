
---
title: "`r OMI@Name`"
subtitle: "ABT-MSE Operating model fitting report"
author: "Tom Carruthers"
date:  "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true 
    
---


<style type="text/css">

body{ /* Normal  */
   font-size: 16px;
}
td {  /* Table  */
   font-size: 16px;
}
title { /* title */
 font-size: 26px;
}
h1 { /* Header 1 */
 font-size: 24px;
 color: DarkBlue;
}
h2 { /* Header 2 */
 font-size: 21px;
 color: DarkBlue;
}
h3 { /* Header 3 */
 font-size: 19px;
 color: DarkBlue;
}
code.r{ /* Code block */
  font-size: 16px;
}
pre { /* Code block */
  font-size: 16px
}
</style>


# Operating model scenario

`r OMI@OMfactors[[1]]`

`r OMI@OMfactors[[2]]`

`r OMI@OMfactors[[3]]`

`r OMI@OMfactors[[4]]`

# Area definitions

```{r plotareas,echo=F,message=F,warning=F,error=F,fig.width=3, fig.height=2.5}

par(mar=rep(0.01,4))
areaplot(OMI)

```

Figure 1. Area definitions for operating model 


# Objective function values and weightings

Table 1. Objective function values (weighted negative log likelihood values)
```{r LHs,echo=F,message=F,warning=F,error=F,fig.width=3, fig.height=2.5}

LHtab<-LHtabs(outs=list(out=out),OMIs=list(OMI=OMI),OMnos=NA, OMnams=NA,rnd=0)
LHs<-LHtab$LHs[,3:ncol(LHtab$LHs)]
wts_tab<-LHtab$wts_tab[,3:ncol(LHtab$wts_tab)]

LHs%>%
 kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = T)


```

Cat = catch data by fleet, quarter and area. CR = the fishery dependent catch rate (CPUE) indices, Surv = fishery-independent survey indices, Comp = length composition data, SOOm = stock of origin microchemistry data, SOOg = stock of origin genetics, Tag = Electronic tagging data, Rec = prior on recruitment deviations, Mov = prior on movement parameters, Sel = prior on size selectivity parameters, SRA = penalty incurred when catches exceed F=1 catches in the stock reduction analysis phase (1864-1964), MI = a prior on similarity to the 'Master Index' that predicts F by year, area, season and fleet, R0diff = a prior on the difference in R0 estimated in two-phase recruitment models (recruitment level 1 and 3), SPr = seasonal distribution prior, TOT_nP = total global objective function without priors, TOT = total global objective function. 


Table 2. Weightings of  likelihood components

```{r wts_tab,echo=F,message=F,warning=F,error=F,fig.width=3, fig.height=2.5}


wts_tab%>%
 kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = T)

```





\newpage

#  Fits to CPUE indices

```{r CPUE fits, fig.width=7, fig.height=9, echo=FALSE}

chunk2 <- function(x,n) split(x, cut(seq_along(x), n, labels = FALSE)) 

groups<-chunk2(1:OMI@nCPUEq,5)

plab<-c(paste0("(",letters[1:26],")"),paste0("(",paste0(letters[1:26],letters[1:26]),")"),paste0("(",paste0(letters[1:26],letters[1:26],letters[1:26]),")"))

firstrow<-match(1:OMI@nCPUEq,OMI@CPUEobs[,4])
Fleetnos<-as.vector(OMI@CPUEobs[firstrow,5])
Seasons<-as.vector(OMI@CPUEobs[firstrow,2])
Areas<-OMI@areanams[as.vector(OMI@CPUEobs[firstrow,3])]

VBi<-out$VB/rep(apply(out$VB,4,mean),each=out$ny*out$ns*out$nr)

for(j in 1:length(groups)){
  
  par(mfrow=c(length(groups[[j]]),2),mai=c(0.3,0.3,0.1,0.01),omi=c(0.3,0.3,0.1,0.05))
  
  for(i in groups[[j]]){
    
    ind<-OMI@CPUEobs[,4]==i
    tempdat<-subset(OMI@CPUEobs,ind)  
    obs<-as.numeric(tempdat[,6])
    pred<-out$CPUEpred_vec[ind]
   
    yrs<-as.numeric(tempdat[,1]+OMI@years[1]-1)
    plot(yrs,obs,pch=19,ylim=c(0,max(obs,pred)),ylab="",xlab="",yaxs='i')
    lines(yrs,pred,lwd=1.5,col="#0000ff95")
    legend('topleft',legend=OMI@CPUEnames[i],bty='n')
    legend('topright',legend=c(paste0("Quarter: ",Seasons[i]),
                               paste0("Area: ",Areas[i])),bty='n')
    mtext(plab[i],3,adj=0.02,line=0.09,cex=0.7)
    
    res<-log(obs)-log(pred)
    resplot(yrs,res)
   
  }
  
  mtext("Relative abundance",2,line=0.5,outer=T)
  mtext("Year",1,line=1,outer=T)
  #cat("\n\n\\pagebreak\n")

}

```

Figure 2. Operating model fits to CPUE indices. Each row corresponds with an index. The left-hand panels show the normalized (log index has mean 0) observed (black dots) and model predicted (blue line) indices. The right-hand panels show the log devitations (the observation model is log-normal) including the residual standard deviation (StDev) and lag-1 autocorrelation in residuals (AC). Runs of positive or negative residuals are highlighted with a red border. The dashed and solid horizontal grey lines are the same on each plot - the scale of y-axis varies among indices for these plots. 

#  Fits to FI indices
```{r FI fits, fig.width=7, fig.height=9, echo=FALSE}

firstrow<-match(1:OMI@nI,OMI@Iobs[,5])
Fleetnos<-as.vector(OMI@Iobs[firstrow,5])
Seasons<-as.vector(OMI@Iobs[firstrow,2])
Areas<-OMI@areanams[as.vector(OMI@Iobs[firstrow,3])]
Types<-as.vector(OMI@Iobs[firstrow,6])

par(mfrow=c(OMI@nI,2),mai=c(0.3,0.3,0.1,0.01),omi=c(0.3,0.3,0.1,0.05))

for(i in 1:OMI@nI){

  ind<-OMI@Iobs[,5]==i
  tempdat<-subset(OMI@Iobs,ind)  
  obs<-as.numeric(tempdat[,7])
  pred<-out$Ipred_vec[ind]
  yrs<-as.numeric(tempdat[,1]+OMI@years[1]-1)
  plot(yrs,obs,pch=19,ylim=c(0,max(obs,pred,na.rm=T)),ylab="",xlab="",yaxs='i')
  lines(yrs,pred,lwd=1.5,col="#0000ff95")
  legend('topleft',legend=OMI@Inames[i],bty='n')
  legend('topright',legend=c(paste0("Quarter: ",Seasons[i]),
                             paste0("Area: ",Areas[i])),bty='n')
  mtext(plab[i],3,adj=0.02,line=0.09,cex=0.7)
  
  res<-log(obs)-log(pred)
  resplot(yrs,res)
}

mtext("Relative abundance",2,line=0.5,outer=T)
mtext("Year",1,line=1,outer=T)
#cat("\n\n\\pagebreak\n")


```

Figure 3. Operating model fits to fishery-independent indices. Each row corresponds with an index. The left-hand panels show the normalized (log index has mean 0) observed (black dots) and model predicted (blue line) indices. The right-hand panels show the log devitations (the observation model is log-normal) including the residual standard deviation (StDev) and lag-1 autocorrelation in residuals (AC). Runs of positive or negative residuals are highlighted with a red border. The dashed and solid horizontal grey lines are the same on each plot - the scale of y-axis varies among indices for these plots. 


# Spawning biomass

```{r allSSB, fig.width=7, fig.height=6,echo=FALSE}

ny<-out$ny
nHy<-out$nHy
np<-out$np
ns<-out$ns
nr<-out$nr
nf<-out$nf
nl<-out$nl
na<-out$na
yrs<-OMI@years[1]:OMI@years[2]

dynB0<-get_dynB0(OMI,out)

opt<-SRplot(out,years=OMI@years,type=OMI@SRtype,plot=F,SRminyr=OMI@SRminyr,SRmaxyr=OMI@SRmaxyr)
R0s<-opt$R0s_now
#res<-MSYMLE(out,OMI)
refyr<-2016-OMI@years[1]+1
res<-doMSY(out,OMI,dynB0,refyr)

allSSB<-cbind(apply(out$hSSB[,2:nHy,],1:2,mean),apply(out$SSB,1:2,mean))# some reason past understanding the model sends the wrong numbers for the first year in SSB
ayv<-(OMI@Hyears[1]+1):OMI@years[2] # some reason past understanding the model sends the wrong numbers for the first year in SSB
matplot(ayv,t(allSSB)/1E6,ylim=c(0,max(dynB0)/1E6),type='l',yaxs='i',col="white",xlab="Year",ylab="SSB (1000 t)")
abline(v=(180:230)*10,col="#99999920")
abline(h=(0:1000)*200,col="#99999920")
matplot(ayv,t(allSSB)/1E6,ylim=c(0,max(dynB0)/1E6),type='l',col=c("red","blue"),lty=c(1,1),add=T,lwd=2)

cols=c("#ff000080","#0000ff80")
for(pp in 1:np){
  lines(OMI@Hyears[1]:OMI@years[2],(dynB0[pp,]*res$BMSY_B0[pp])/1E6,col=cols[pp],lty=3,lwd=2)
  lines(OMI@Hyears[1]:OMI@years[2],dynB0[pp,]/1E6,col=cols[pp],lty=2,lwd=2)
}

abline(v=mean(OMI@Hyears[2],OMI@years[1]),col="#99999950",lwd=2)
legend('topleft',legend=c("West stock","East stock"),text.col=c("blue","red"),bty='n')
legend('top',legend=c("Dyn. B0","Dyn. BMSY"),lty=c(2,3),bty='n',lwd=2)
  
```

Figure 4a. Historical spawning biomass. Dynamic unfished spawning biomass (Dyn. B0) is calculated using year-specific estimates of unfished recruitment (depending on which R0 phase the model is in) assuming that there was zero fishing (ie it lags shifts in productivity). Dynamic BMSY is a fixed fraction of B0 based on the most recent estimates of BMSY relative to unfished (the steepness parameter assumed for 2016). Since in some operating models, R0 is changing over time, the maximum achievable level of stock biomass is also changing and keeping track of dynamic B0 provide a realistic yardstick for evaluating management performance.    


```{r allSSB2, fig.width=7, fig.height=5.5,echo=FALSE}

yrs<-OMI@years[1]:OMI@years[2]

allSSB<-apply(out$SSB,1:2,mean)
matplot(OMI@years[1]:OMI@years[2],t(allSSB)/1E6,ylim=c(0,max(allSSB)/1E6),type='l',col="white",yaxs='i',xlab="Year",ylab="SSB (1000 t)")
abline(v=(180:230)*10,col="#99999920")
abline(h=(0:1000)*200,col="#99999920")
matplot(OMI@years[1]:OMI@years[2],t(allSSB)/1E6,ylim=c(0,max(allSSB)/1E6),type='l',col=c("red","blue"),lty=c(1,1),add=T)

cols=c("#ff000080","#0000ff80")
for(pp in 1:np){
  lines(OMI@years[1]:OMI@years[2],(dynB0[pp,nHy+(1:ny)]*res$BMSY_B0[pp])/1E6,col=cols[pp],lty=3,lwd=2)
  lines(OMI@years[1]:OMI@years[2],dynB0[pp,nHy+(1:ny)]/1E6,col=cols[pp],lty=2,lwd=2)
}
legend('topleft',legend=c("West stock","East stock"),text.col=c("blue","red"),bty='n')
legend('top',legend=c("Dyn. B0","Dyn. BMSY"),lty=c(2,3),bty='n',lwd=2)
  
```

Figure 4b. Recent spawning biomass. Dynamic unfished spawning biomass (Dyn. B0) is calculated using year-specific estimates of recruitment strength assuming that there was zero fishing (ie it lags shifts in productivity). Dynamic BMSY is a fixed fraction of B0 based on the most recent estimates of BMSY relative to unfished.


# Assessment comparison

```{r 2017comp, fig.width=7.5, fig.height=5,echo=FALSE}
# M3 SSB calculation
Nind<-TEG(dim(out$N))
SSB<-array(NA,dim(out$N))
SSB[Nind]<-out$N[Nind]*out$mat_age[Nind[,c(1,4)]]*out$wt_age[Nind[,c(2,4,1)]]
SSBsum<-apply(SSB,c(2,3,5),sum) # SSB by year and area in spawning season
SSBmu<-apply(SSBsum,c(1,3),mean)
#sum(SSBmu[55,])==sum(SSBsum[55,,])/4 # Debug test
muSSB<-array(NA,c(np,ny))
muSSB[1,]<-apply(SSBmu*rep(c(0,0,0,1,1,1,1),each=out$ny),1,sum)
muSSB[2,]<-apply(SSBmu*rep(c(1,1,1,0,0,0,0),each=out$ny),1,sum)
muSSBc<-apply(muSSB,2,sum)

EWareas<-array(NA,c(out$np,out$ny,out$nr))
EWareas[1,,]<-rep(c(0,0,0,1,1,1,1),each=out$ny)
EWareas[2,,]<-rep(c(1,1,1,0,0,0,0),each=out$ny)

snams<-c("East","West")
stocknames<-c("East area","West area","All Atlantic")
endind<-(-4:0)+ny
Rec<-apply(out$N[,,out$spawns[1],1,],1:2,sum)*exp(out$M_age[,1])# got to add back in mortality from end of time step
Reclast<-Rec[,endind]
Rec[,(-3:0)+ny]<-NA

Recc<-apply(Rec,2,sum)
yrs<-OMI@years[1]:OMI@years[2]

par(mfcol=c(2,3),mai=c(0.35,0.35,0.01,0.01),omi=c(0.1,0.4,0.3,0.05))

for(pp in out$np:1){
  
  # SSB 
  tdat<-subset(dat,dat$area==snams[pp])[,c(2:4)]
  names(tdat)<-c("Assessment","Year","Val")
  
  ylim<-c(0,max(muSSB[pp,]/1E6,as.numeric(as.character(tdat$Val[tdat$Year>(OMI@years[1]-1)]))/1000,na.rm=T))
  plot(yrs,muSSB[pp,]/1E6,lwd=2,ylab="",type="l",ylim=ylim,yaxs='i')
  cond<-tdat$Assessment=="SS"
  lines(tdat$Year[cond],as.numeric(as.character(tdat$Val[cond]))/1000,col="#ff000090",lwd=2)
  lines(tdat$Year[!cond],as.numeric(as.character(tdat$Val[!cond]))/1000,col="#00ff0090",lwd=2)
  mtext(stocknames[pp],3,line=1,font=2)
  if(pp==out$np)mtext("SSB(kt)",2,line=2.8,font=2)
  
  # Rec
  tdat<-subset(dat,dat$area==snams[pp])[,c(2,3,5)]
  names(tdat)<-c("Assessment","Year","Val")
  tdat$Val[tdat$Year>(OMI@years[2]-3)]<-NA
  ylim<-c(0,max(Rec[pp,]/1E6,as.numeric(as.character(tdat$Val[tdat$Year>(OMI@years[1]-1)]))/1E6,na.rm=T))
  plot(yrs,Rec[pp,]/1E6,lwd=2,ylab="",type="l",ylim=ylim,yaxs='i')
  lines(yrs[endind],Reclast[pp,],col='grey',lwd=2,lty=1)
  cond<-tdat$Assessment=="SS"
  lines(tdat$Year[cond],as.numeric(as.character(tdat$Val[cond]))/1E6,col="#ff000090",lwd=2)
  lines(tdat$Year[!cond],as.numeric(as.character(tdat$Val[!cond]))/1E6,col="#00ff0090",lwd=2)
  if(pp==out$np)mtext("Recruitment (m)",2,line=2.8,font=2)
  
}

# SSB combined

tdat<-dat[,c(2:4)]
names(tdat)<-c("Assessment","Year","Val")
tdat<-aggregate(tdat$Val,by=list(tdat$Year,tdat$Assessment),sum)
names(tdat)<-c("Year","Assessment","Val")
ylim<-c(0,max(muSSB[pp,]/1E6,as.numeric(as.character(tdat$Val[tdat$Year>(OMI@years[1]-1)]))/1000,na.rm=T))
 
#ylim<-c(0,max(muSSBc/1000,as.numeric(as.character(tdat$Val))))
plot(yrs,muSSBc/1E6,lwd=2,ylab="",type="l",ylim=ylim,yaxs='i')
cond<-tdat$Assessment=="SS"
lines(tdat$Year[cond],as.numeric(as.character(tdat$Val[cond]))/1000,col="#ff000090",lwd=2)
lines(tdat$Year[!cond],as.numeric(as.character(tdat$Val[!cond]))/1000,col="#00ff0090",lwd=2)

mtext(stocknames[3],3,line=1,font=2)
legend('topleft',legend=c("M3","SS","VPA"),cex=1.2,text.col=c('black','red','green'),text.font=2,bty='n')


# Recruitment combined
tdat<-subset(dat,dat$area==snams[pp])[,c(2,3,5)]
names(tdat)<-c("Assessment","Year","Val")
tdat$Val[tdat$Year>(OMI@years[2]-3)]<-NA

ylim<-c(0,max(Recc/1E6,as.numeric(as.character(tdat$Val[tdat$Year>(OMI@years[1]-1)]))/1E6,na.rm=T))
plot(yrs,Recc/1E6,lwd=2,ylab="",type="l",ylim=ylim,yaxs='i')
cond<-tdat$Assessment=="SS"
lines(tdat$Year[cond],as.numeric(as.character(tdat$Val[cond]))/1E6,col="#ff000090",lwd=2)
lines(tdat$Year[!cond],as.numeric(as.character(tdat$Val[!cond]))/1E6,col="#00ff0090",lwd=2)
if(pp==out$np)mtext("Recruitment",2,line=2.8,font=2)


```

Figure 5. Regional comparisons (45deg W) with 2017 stock assessment. Note that annual estimates from the operating model are calculated from average of the seasonal predictions. The last four years of recruitment estimates are represnted by a grey dotted line (are not well estimated by the model and not used in forward projection - ie future recruitment starts three years prior to the final historical year of model fitting). 

# Stock-recruitment relationships 

```{r Stock-recruitment, fig.width=7.5, fig.height=7.5,echo=FALSE}

 opt<-SRplot(out=out,years=OMI@years,type=OMI@SRtype,plot=T,SRminyr=OMI@SRminyr, SRmaxyr=OMI@SRmaxyr)

```

Figure 6a. Model predicted spawning stock biomass and recruitment. h is the assumed value of steepness, lnR0 is the log unfished recruitment. The red point is the most recent SSB-Recruitment estimate. 


```{r SRyr, fig.width=12.5, fig.height=12.5,echo=FALSE}


 opt<-SRplotYR(out=out,years=OMI@years,type=OMI@SRtype,plot=T,SRminyr=OMI@SRminyr, SRmaxyr=OMI@SRmaxyr)

 

```



Figure 6b. Model predicted spawning stock biomass and recruitment. h is the assumed value of steepness, lnR0 is the log unfished recruitment. The red point is the most recent SSB-Recruitment estimate. 


```{r recdevs, fig.width=7.5, fig.height=7.5,echo=FALSE}

nt<-rep(1,2)
yswitch<-rep(NA,2)

for(pp in 1:out$np) {
  recs<-unique(out$R0[pp,])
  nt[pp]<-length(recs)
  if(nt[pp]>1)yswitch[pp]=match(recs[2],out$R0[pp,])
}

tott<-sum(nt)
if(tott==2){
  row1<-row2<-c(1,1,2,2)
}else{
  if(nt[1]==1){
    row1<-c(tott,1,1,tott)
    tott<-tott+1
    n1<-1
  }else{
    row1<-c(1,1,2,2)
    n1=2
  }

  if(nt[2]==1){
    row2<-c(tott+1,nt[1]+1,nt[1]+1,tott+1)
  }else{
    row2<-c(1,1,2,2)+nt[1]
  }
}

par(mfrow=c(out$np,2),mai=c(0.4,0.5,0.3,0.05),omi=c(0.5,0.5,0.5,0.01))
layout(cbind(row2,row1))

resid<-opt$resid
nplot<-length(resid)

for(i in 1:nplot){
  sausage<-T
  if(sausage){
  nyrs<-nrow(resid[[i]])
  ind<-rep(T,nyrs)#rep(c(T,F),1000)[1:nyrs]
  estrec<-resid[[i]]$rec[ind]
  dev<-resid[[i]]$devs[ind]
  modrec<-estrec-dev
  SSB<-resid[[i]]$SSB[ind]
 
  res0<-log(estrec/modrec)
  yrs<-resid[[i]]$yrs[ind]

  cols<-rep('blue',length(res0))
  cols[res0<0]<-'red'
  barplot(res0,names.arg=yrs,border="white",col=cols)
  abline(h=0,col="#99999960",lwd=2)
  ac<-round(acf(res0,plot=F)$acf[2,1,1],2)
  sd<-round(sd(res0),2)
  legend('topright',legend=c(paste0("St.Dev. = ",sd), paste0("A.C. = ", ac)),bty='n')
  if(nplot==2)mtext(c("East stock","West stock")[i],3,line=0.8,font=2)
 }else{
  plot(1:10,1:10,col='white',axes=F,xlab="",ylab="",main="")
  legend('center',legend="Under construction",bty='n',cex=1.2)
 }
}

if(nplot>2)mtext(c("West stock","East stock"),3,at=c(0.25,0.75),line=0.8,outer=T,font=2)
mtext("Year",1,line=0.8,outer=T,font=2)
mtext("Log recruitment deviations",2,line=0.8,outer=T,font=2)
 

```

Figure 6c. Recruitment deviations (log) for each stock-recruitment curve. Recruitment deviations are modelled for two-year time blocks. Blue bars represent positive deviations where the estimated recruitment is higher than the mean value predicted from the stock-recruitment curve. Red bars represent negative deviations. 'St.Dev'. and 'A.C'. refer to the Standard Deviation and lag-1 (assuming each block is a time period) autocorrelation in recruitment deviations. 


# MSY reference points 

```{r refpoints_2016, results='asis',echo=FALSE,fig.width=5}

Wareas<-1:3
Eareas<-4:7

B<-SSB2<-array(NA,dim(out$N))

ind<-TEG(dim(out$N))
indw<-ind[,c(2,4,1)]
B[ind]<-out$N[ind]*out$wt_age[indw]
SSB2[ind]<-out$N[ind]*out$wt_age[indw]*out$mat_age[indw[,3:2]]
SSBmu2<-apply(SSB2,c(5,3,2,1),mean)

RAIp<-apply(B,c(5,3,2),sum) # r s y
RAIo<-out$RAI
muRAIp<-mean(RAIp)
RAIp<-RAIp/muRAIp
RAIo<-RAIo/mean(RAIo) 

RAIpP<-apply(B,c(5,3,2,1),sum) # r s y p
A_EinW<-apply(RAIpP[Wareas,,,1],3,sum)
A_EinE<-apply(RAIpP[Eareas,,,1],3,sum)
A_WinW<-apply(RAIpP[Wareas,,,2],3,sum)
A_WinE<-apply(RAIpP[Eareas,,,2],3,sum)

RAIpP<-RAIpP/muRAIp

EinW<-apply(RAIpP[Wareas,,,1],3,sum)
EinE<-apply(RAIpP[Eareas,,,1],3,sum)
WinW<-apply(RAIpP[Wareas,,,2],3,sum)
WinE<-apply(RAIpP[Eareas,,,2],3,sum)

F_EinW<-EinW/(EinE+EinW)
F_WinE<-WinE/(WinW+WinE)

F_E_E<-EinE/(EinE+WinE)
F_E_W<-EinW/(EinW+WinW)
F_W_E<-WinE/(EinE+WinE)
F_W_W<-WinW/(EinW+WinW)

refyr<-2016-OMI@years[1]+1

res2<-doMSY(out,OMI,dynB0,refyr)

MSY<-c( (1-F_EinW[ny])*res2$MSY[1]+F_WinE[ny]*res2$MSY[2], 
            F_EinW[ny]*res2$MSY[1]+(1-F_WinE[ny])*res2$MSY[2] )

BMSY<-c( (1-F_EinW[ny])*res2$BMSY[1]+F_WinE[ny]*res2$BMSY[2], 
            F_EinW[ny]*res2$BMSY[1]+(1-F_WinE[ny])*res2$BMSY[2] )

BMSY_B0<-c( (EinE[ny]*res2$BMSY_B0[1]+WinE[ny]*res2$BMSY_B0[2])/sum(EinE[ny],WinE[ny]),
             (EinW[ny]*res2$BMSY_B0[1]+WinW[ny]*res2$BMSY_B0[2])/sum(EinW[ny],WinW[ny]) )

B_BMSY<-c( (EinE[ny]*res2$B_BMSY[1]+WinE[ny]*res2$B_BMSY[2])/sum(EinE[ny],WinE[ny]),
             (EinW[ny]*res2$B_BMSY[1]+WinW[ny]*res2$B_BMSY[2])/sum(EinW[ny],WinW[ny]) )

Dep<-c( (EinE[ny]*res2$Dep[1]+WinE[ny]*res2$Dep[2])/sum(EinE[ny],WinE[ny]),
             (EinW[ny]*res2$Dep[1]+WinW[ny]*res2$Dep[2])/sum(EinW[ny],WinW[ny]) )

MSY<-round(MSY,0)
BMSY<-round(BMSY,0)
BMSY_B0<-round(BMSY_B0,3)
B_BMSY<-round(B_BMSY,3)
Dep<-round(Dep,3)

#res_area<-data.frame(MSY,BMSY,BMSY_B0,B_BMSY,Dep)
#row.names(res_area)<-c("East area","West area")

#res_area %>%
#kable(format = "html", escape = F) %>%
#  kable_styling("striped")#, full_width = T)

#Table 3a. 2016 Reference points by area. MSY and BMSY numbers are in tons. Biomass figures (BMSY, B0) refer to Spawning #Stock Biomass. Stock depletion refers to spawning stock biomass relative to 'dynamic B0' (a running calculation of #unfished stock size accounting for shifts in recruitment). Similarly, BMSY is calculated as a dynamic quantity relating to #'dynamic B0'. 

```

Table 3. 2016 Reference points by stock. MSY and BMSY numbers are in tons. Biomass figures (BMSY, B0) refer to Spawning Stock Biomass. Fishing rate figures (FMSY, F) are phrased as apical Fs (F on the most selected length class). Stock depletion refers to spawning stock biomass relative to 'dynamic B0' (a running calculation of unfished stock size accounting for shifts in recruitment). Similarly BMSY is calculated as a dynamic quantity relating to 'dynamic B0'. 

```{r refpoints_2016_area, results='asis',echo=FALSE,fig.width=5}
res2 %>%
kable(format = "html", escape = F) %>%
  kable_styling("striped")#, full_width = T)
```

```{r refpoints_figs, fig.width=8, fig.height=5,echo=FALSE}

par(mfrow=c(1,2),mai=c(0.5,0.5,0.1,0.1),omi=c(0.4,0.4,0.3,0.01)) 
yr<-51
Fprof<-meanFs(FML=out$FL[yr,,,,], iALK=out$iALK[,yr,,], N=out$N[,yr,,,],
                wt_age=t(out$wt_age[yr,,]))

V=Fprof/apply(Fprof,1,max)
nams<-c('East','West')

aggCL<-aggregate(OMI@CLobs[,6],by=list(OMI@CLobs[,5]),sum)

agearray<-array(rep(1:OMI@na,each=OMI@np),c(OMI@np,OMI@na,OMI@ny))
len_age<-len_age2<-wt_age<-array(NA,dim(agearray))
ind<-TEG(dim(agearray))
len_age[ind]<-(
                 OMI@L1[ind[,1]]^OMI@p[ind[,1]]+(OMI@L2[ind[,1]]^OMI@p[ind[,1]]-OMI@L1[ind[,1]]^OMI@p[ind[,1]])*
                 (
                   (1-exp(-OMI@K[ind[,1]]*agearray[ind]))/
                   (1-exp(-OMI@K[ind[,1]]*OMI@A2[ind[,1]]))
                 )
               )^(1/OMI@p[ind[,1]])


len_age2[ind]<-OMI@Linf[ind[,1]]*(1-exp(-OMI@K[ind[,1]]*(agearray[ind]-OMI@t0[ind[,1]])))

cond<-is.na(len_age[,1,1])
len_age[cond,,]<-len_age2[cond,,]

nlen<-length(OMI@lenbins)-1

ind<-TEG(dim(wt_age))
wt_age[ind]<-OMI@lwa[ind[,1]]*len_age[ind]^OMI@lwb[ind[,1]]

ALK<-array(NA,c(OMI@np,OMI@ny,OMI@na,OMI@nl))
ind<-TEG(dim(ALK))
Lind<-ind[,c(1,3,2)]
ALK[ind]<-dlnorm(OMI@mulen[ind[,4]],log(len_age[Lind]),(OMI@Lvar_a[ind[,1]]*len_age[Lind]+OMI@Lvar_b[ind[,1]])/len_age[Lind])
sums<-apply(ALK,c(1,2,4),sum)
sind<-ind[,c(1,2,4)]
ALK<-ALK/sums[sind]

for(pp in 2:1){
  
  len<-OMI@len_age[pp,,yr]/max(OMI@len_age[pp,,yr])
  mat<-OMI@mat[pp,,yr]
  surv<-exp(-cumsum(c(0,OMI@Ma[pp,])))[1:OMI@na]
  CAA=apply(aggCL[,2]*t(ALK[pp,51,,]),2,sum)
  CAA=CAA/max(CAA)
  selsurv=V[pp,]*surv
  selsurv=selsurv/max(selsurv)
  
  plot(V[pp,],type='l',ylim=c(0,1),yaxs='i')
  lines(len,col='red')
  lines(mat,col='blue')
  lines(surv,col='grey')
  CAA[1]<-selsurv[1]<-NaN
  lines(CAA,col='orange')
  lines(selsurv,col="brown")
  
  if(pp==1)legend('right',legend = c("Selectivity","Length","Maturity","Survival","Catch comp","Sel x surv"),
                  text.col=c('black','red','blue','grey','orange','brown'),bty='n')
  mtext(nams[pp],3)
}

mtext('Age',1,outer=T)
mtext('Relative to max',2,outer=T)


  
```

Figure 7. Age-specific quantities determining 2016 MSY reference points. Survival is based on natural mortality only. Catch comp (orange line) is the age composition of all catch at length data (converted to age via an ALK). Sel x surv is the unfished predicted age composition of catches based on 2016 selectivity (black line) and unfished age structure from survival (grey line). Sel x surv (brown line) provides an approximate check of the model approximation of catch composition. The sel x surv should be of higher age (to the right of) the catch comp that is from an exploited population. 


# Estimated size selectivity

```{r estimatedsels, fig.width=6.5, fig.height=4,echo=FALSE}
  fleetnams=OMI@Fleets$name
  nr<-out$nr
  nf<-out$nf
  nl<-out$nl
  fcols<-rep(c("black","orange","#99999980","#ff000080","#00ff0080",
               "#0000ff80","#80802080","#ff00ff80","#00ffff80"),2)
  ltys<-rep(c(1,2),each=9)
 
  par(mai=c(0.05,0.15,0.01,0.01),omi=c(0.66,0.5,0.1,0.05))
  
  plot(out$ml[c(1,nl)],c(0,1),col='white',lwd=2,type='l',lty=ltys[1],yaxs='i')
  
  for(f in 1:nf){
    
    lines(out$ml,out$sel[f,],col=fcols[f],lwd=2,lty=ltys[f])
    
  }
  legend('topright',legend=fleetnams,cex=0.7,text.font=2,text.col=fcols[1:nf],bty='n',col=fcols[1:nf],lty=ltys[1:nf])
  
  mtext("Length (cm)",1,outer=T,line=2)
  mtext("Selectivity",2,outer=T,line=1.5)

```

Figure 8a. The size selectivity of the various fishing fleets estimated in the operating model. 

```{r estimatedselsbyfleet, fig.width=7.5, fig.height=7.5,echo=FALSE}

  par(mfrow=c(ceiling(nf/3), 3),mai=c(0.15,0.25,0.01,0.01),omi=c(0.66,0.5,0.1,0.05))

  for(f in 1:nf){
     plot(out$ml,out$sel[f,],type='l',lty=ltys[1],yaxs='i',col='blue',ylim=c(0,1.05),axes=F)
     axis(1,at=(0:20)*50,labels=f>(nf-4))
     axis(2)
     legend('topright',legend=fleetnams[f],text.col="blue",text.font=2,bty='n')
  }
  
  mtext("Length (cm)",1,outer=T,line=2)
  mtext("Selectivity",2,outer=T,line=1.5)

```

Figure 8b. The size selectivity of the various fishing fleets estimated in the operating model. 

# Fit to aggregate catches ###

```{r catchaggfit, fig.width=8.5, fig.height=11,echo=FALSE}

  firstyr=OMI@years[1]
  fleetnams=OMI@Fleets$name
  areanams=OMI@areanams
  fcols<-c("#99999980","#ff000080","#00ff0080","#0000ff80","#ffff0080")

  np<-out$np   
  ny<-out$ny
  ns<-out$ns
  nr<-out$nr
  nf<-out$nf
  na<-out$na
  nl<-out$nl
  
  yrs<-firstyr:(firstyr+ny-1)
  
  # Fit to catches --------------------------
  col1<-c("red","blue","green","orange","grey","pink","brown","yellow","black","purple")
  cols<-makeTransparent(col1,90)
  
  CobsA<-array(NA,c(ny,ns,nr,nf))
  CobsA[out$Cobs[,1:4]]<-out$Cobs[,5]
  Co<-CobsA/1000
  Cp<-out$Cpred/1000
 
  layout(matrix(c(1,3,4,2),nrow=2),heights=c(1,2))
  par(mai=c(0.8,0.45,0.4,0.01),omi=c(0.9,0.3,0.4,0.05))
  
  
  # Total catch
  ylim=c(0,max(c(apply(Co,1,sum,na.rm=T),apply(Cp,1,sum,na.rm=T))))
  plot(yrs,apply(Co,1,sum,na.rm=T),ylab="Catch (t)",pch=19,ylim=ylim,axes=F,yaxs = "i" )
  axis(1)
  axis(2)
  lines(yrs,apply(Cp,1,sum,na.rm=T),col="#ff000090")
  mtext("Total catch (all fleets, stocks, areas, seasons)",3,line=0.6)
  
  # By area
  ylim<-c(0,max(apply(Co,c(1,3),sum,na.rm=T),apply(Cp,c(1,3),sum,na.rm=T)))
  matplot(yrs,apply(Co,c(1,3),sum,na.rm=T),pch=19,col=cols,ylim=ylim,ylab="Catch (t)",lwd=2,axes=F,yaxs = "i" )
  axis(1)
  axis(2)
  matplot(yrs,apply(Cp,c(1,3),sum,na.rm=T),type="l",add=T,col=cols,lty=1,lwd=2,yaxs = "i" )
  legend('topright',legend=OMI@areanams,text.col=col1,bty='n')
  mtext("Catch by area (all fleets, stocks, seasons)",3,line=0.6)
 
  # By season
  ylim<-c(0,max(apply(Co,1:2,sum,na.rm=T),apply(Cp,1:2,sum,na.rm=T)))
  matplot(yrs,apply(Co,1:2,sum,na.rm=T),pch=19,ylim=ylim,col=cols,lwd=2,axes=F,yaxs = "i" )
  axis(1)
  axis(2)
  matplot(yrs,apply(Cp,1:2,sum,na.rm=T),type="l",add=T,col=cols,lwd=2)
  legend('topright',legend=1:4,text.col=col1,bty='n')
  mtext("Catch by quarter (all fleets, stocks, seasons)",3,line=0.6)
 
  # By fleet
  tempobs<-apply(Co,4,sum,na.rm=T)
  temppred<-apply(Cp,4,sum,na.rm=T)
  barplot(tempobs,ylim=c(0,max(tempobs,temppred)),names.arg=OMI@Fleets$name,col="dark grey",las=2,border=NA)#sum,na.rm=T),pch=19)
  mtext("Catch by fleet (all years, stocks, seasons)",3,line=0.6)
  barplot(temppred,col=NA,border="red",add=T,lwd=2)#sum,na.rm=T),pch=19)
  
  mtext("Catch (t)",2,line=0.4,outer=T)
  
```

Figure 9. Fit to a observed total catches (tons) aggregated over various axes (lines = predicted, points = observed)


# Fit to length composition 

```{r fit to agg length observations, fig.width=7.5, fig.height=17,echo=FALSE}

  barplotT<-function(x,y,ylim,axes=F,col='orange',lwd=4){
    
    plot(x,y,col=NA,ylim=ylim,axes=axes)
    for(i in 1:length(x))lines(rep(x[i],2),c(0,y[i]),col=col,lwd=lwd)
    at<-(0:8)*50
    axis(1,at,at)
    
  }

  cexmult<-4
  maxcex<-1.5

  CLobsA<-CLpredA<-array(NA,c(ny,ns,nr,nf,nl))
  CLobsA[out$CLobs[,1:5]]<-out$CLobs[,6]
  CLpredA[out$CLobs[,1:5]]<-out$CLprop
  
  CLo<-apply(CLobsA,c(1,4,5),sum,na.rm=T)
  CLotot<-array(apply(CLo,1:2,sum,na.rm=T),dim(CLo))
  CLo<-CLo/CLotot
  
  CLp<-apply(CLpredA,c(1,4,5),sum,na.rm=T)
  CLptot<-array(apply(CLp,1:2,sum,na.rm=T),dim(CLp))
  CLp<-CLp/CLptot
  
  PR<-(CLo-CLp)
 
  cexy<-abs(PR*cexmult)^0.5
  pchy<-array(19,dim=dim(cexy))
  coly<-array('#0000ff95',dim=dim(cexy))
  coly[PR>0]<-'orange'
 
  CLoa<-apply(CLo,2:3,sum,na.rm=T)/apply(CLo,2,sum,na.rm=T)
  CLpa<-apply(CLp,2:3,sum,na.rm=T)/apply(CLp,2,sum,na.rm=T)
  
  ind<-(OMI@ny-9):OMI@ny
  CLoa10<-apply(CLo[ind,,],2:3,sum,na.rm=T)/apply(CLo[ind,,],2,sum,na.rm=T)
  CLpa10<-apply(CLp[ind,,],2:3,sum,na.rm=T)/apply(CLp[ind,,],2,sum,na.rm=T)
 
  # Those spatio-temporal strata with at least one length observation
  CLpredFill<-array(FALSE,c(ny,ns,nr,nf,nl)) # logical array - should predictions be filled?
  CLpredAZ<-array(NA,c(ny,ns,nr,nf,nl))      # new prediction arrary where there is at least one observation
  CLind<-aggregate(rep(1,nrow(out$CLobs)),by=list(out$CLobs[,1],out$CLobs[,2],out$CLobs[,3],out$CLobs[,4]),sum)
  
  fill<-cbind(rep(CLind[,1],each=out$nl), rep(CLind[,2],each=out$nl),
        rep(CLind[,3],each=out$nl), rep(CLind[,4],each=out$nl),
        rep(1:out$nl,nrow(CLind))) # For each time x area strata of CLind, create all length class indices
  
  CLpredFill[fill] <- TRUE   # The matrix locations that need filling
  CLpredAZ[CLpredFill]<-out$CLtotpred[CLpredFill]
  CLpZ<-apply(CLpredAZ,c(1,4,5),sum,na.rm=T)
  CLptotZ<-array(apply(CLpZ,1:2,sum,na.rm=T),dim(CLpZ))
  CLpZ<-CLpZ/CLptotZ
  CLpaZ<-apply(CLpZ,2:3,sum,na.rm=T)/apply(CLpZ,2,sum,na.rm=T)
  ind<-(OMI@ny-9):OMI@ny
  CLpaZ10<-apply(CLpZ[ind,,],2:3,sum,na.rm=T)/apply(CLpZ[ind,,],2,sum,na.rm=T)

  if(OMI@LC_LHF==3){ 
    eps <- CLo^0.5 - CLpZ^0.5 
  }else{
    eps<- (CLo+tiny)^0.5 * (log(CLo+tiny)-log(CLp+tiny))
  }
  
  par(mai=c(0.3,0.3,0.01,0.01),omi=c(0.3,0.3,0.1,0.05))
  dmat<-array(c((1:nf)*2-1,(1:nf)*2),c(nf,2))
  layout(dmat,widths=c(2,1))
  
  for(ff in 1:nf){
    
    yrng<-range(out$CLobs[out$CLobs[,4]==ff,1],na.rm=T)
    yind<-yrng[1]:yrng[2]
    yrs<-yind+OMI@years[1]-1
    cex0<-cexy[yind,ff,]
    pch0<-pchy[yind,ff,]
    col0<-coly[yind,ff,]
    cex0[cex0>maxcex]<-maxcex
    xs<-rep(yrs,OMI@nl)
    ys<-rep(1:OMI@nl,each=length(yrs))
    plot(xs,ys,cex=cex0,pch=pch0,col=col0,axes=F,xlab="Year",ylab="Length (cm)")
    axis(1)
    axis(2,1:OMI@nl,OMI@mulen)
    legend('topleft',legend=OMI@Fleets$name[ff],bty='n')
    ys<-apply(eps[,ff,],2,sum,na.rm=T)
    barplot(ys,col=c('orange','blue')[as.integer(ys<0)+1],border=NA)
    

  }
 
``` 

Figure 10. Length composition residuals. The left-hand panels show residuals over time. Orange circles are positive residuals (observed proportion is higher than expected), blue circles are negative residuals. The area of the circle is proportional to the residual error where residual = (observed)^0.5 * (log(observed)-log(predicted)).  


```{r Res, fig.width=7.5, fig.height=9,echo=FALSE}

  # eps(u,l) = sqrt(p(u,l)) * {ln(p(u,l)) – ln(phat(u,l))}
 # eps_Z <- CLo^0.5 * (log(CLo)-log(CLpZ))
  # eps(u,l) = sqrt(p(u,l)) – sqrt(phat(u,l))
  # eps_s <- CLo^0.5 - CLp^0.5
  
  ncol=3
  nrow<-ceiling(out$nf/ncol)
  
  par(mfrow=c(nrow,ncol),mar=rep(1.5,4))
  
  for(ff in 1:out$nf){
   
     
    ylim=c(0,max(CLoa[ff,],CLpa[ff,]))
    barplotT(out$ml,CLoa[ff,],ylim=ylim)

    if(exists('oldfit'))lines(out$ml,CLpa[ff,],col="#0000ff90",lwd=2)
    lines(out$ml,CLpaZ[ff,],col="green",lwd=2)
    legend('topleft',legend=OMI@Fleets$name[ff],bty='n')
   
   
  }
  
  

 
```

Figure 11. Model predicted length composition (green line) and observed length composition (orange bars) aggregated over years and spatial strata. Where length observations are missing, these are assumed to be zero and model predictions are assumed to be positive.  



# Spatial distribution 

```{r indexfit, fig.width=7, fig.height=9.5,echo=FALSE}

  ny<-out$ny
  np<-out$np
  ns<-out$ns
  nr<-out$nr
  nf<-out$nf
  nl<-out$nl
  
  yrs<-OMI@years[1]:OMI@years[2]

  pch<-19
  cex<-0.8
  lwd=1.5
  pcols<-c("Red","Blue","#00ff0080","#ffff0080")
  
  popnams=c("East","West")
  subyrnams=c("Jan-Mar","Apr-Jun","Jul-Sept","Oct-Dec")
  areanams=OMI@areanams

  par(mfcol=c(nr,ns),mai=c(0.05,0.15,0.01,0.01),omi=c(0.4,0.5,0.1,0.05))
  ylim=c(0,max(RAIp,na.rm=T))
  ys<-pretty(seq(ylim[1],ylim[2]*1.2,length.out=4))
  xs<-pretty(seq(yrs[1],yrs[ny],length.out=6))
 
  l<-1
  
  for(s in 1:ns){
  
    for(r in 1:nr){
    
      plot(yrs,RAIp[r,s,],col="purple",pch=pch,ylim=ylim,axes=F,lwd=2,type="l",yaxs='i')
      for(p in 1:np){
        lines(yrs,RAIpP[r,s,,p],col=pcols[p],lwd=1.5)
      }
    
      if(r==nr)axis(1,xs,xs)
      if(r<nr)axis(1,xs,NA)
      if(s==1)axis(2,ys,ys)
      if(s<(ns+1))axis(2,ys,NA)
      if(s==1)mtext(areanams[r],2,line=2.75)
      if(r==1)mtext(subyrnams[s],3,line=-0.5)
      if(r==1&s==ns)legend('topright',legend=c("Total",popnams),text.font=2,text.col=c("purple",pcols[1:np]),bty='n')
      
      mtext(plab[l],3,adj=0.02,line=-1.5,cex=0.7)
      l=l+1
    }
  
  }

  mtext("Year",1,outer=T,line=2)
  
```

Figure 12. The predicted seasonal and spatial biomass of Atlantic bluefin tuna by stock. 


# Estimated unfished movement

```{r est_mov_dist, fig.width=8, fig.height=1.6,echo=FALSE}
plot_mov_dist(out,OMI)

par(mfrow=c(2,2),mai=c(0.6,0.01,0.01,0.01))
for(i in 1:3)plot(1,1,col="white",axes=F,xlab="",ylab="",main="")
ncol<-100
vcol<-rainbow(ncol,s=1,v=1,start=0,end=0.45,alpha=1)[ncol:1]
trans<-(1:ncol)/3*10
trans[trans>255]<-255
for(i in 1:100)vcol[i]<-makeTransparent(vcol[i],trans[i])
plot(c(0,100),c(0,1),axes=F,col="white",xlab="",ylab="")
for(i in 1:ncol)polygon(c(i-1,i,i,i-1),c(0,0,1,1),col=vcol[i],border=NA)
axis(1,seq(0,100,length.out=11))
mtext("Percentage of fish by number",1,line=2.1)

```

Figure 13a. The movement and distribution of fish under unfished conditions. The square matrices show the fraction of fish moving from an area (rows) to an area (columns). These rows sum to 100% of fish and are color coded according to the fraction going to each area (column). The vertical bars after each square matrix is the ending distribution of fish (the new 'from area' by row) after this movement has occured. 


```{r est_mov, fig.width=8, fig.height=1.6,echo=FALSE}
plot_mov(out,OMI)

par(mfrow=c(2,2),mai=c(0.6,0.01,0.01,0.01))
for(i in 1:3)plot(1,1,col="white",axes=F,xlab="",ylab="",main="")
ncol<-100
vcol<-rainbow(ncol,s=1,v=1,start=0,end=0.45,alpha=1)[ncol:1]
trans<-(1:ncol)/3*10
trans[trans>255]<-255
for(i in 1:100)vcol[i]<-makeTransparent(vcol[i],trans[i])
plot(c(0,100),c(0,1),axes=F,col="white",xlab="",ylab="")
for(i in 1:ncol)polygon(c(i-1,i,i,i-1),c(0,0,1,1),col=vcol[i],border=NA)
axis(1,seq(0,100,length.out=11))
mtext("Percentage of fish by number",1,line=2.1)

```

Figure 13b. The movement transition probabilities. The square matrices show the fraction of fish moving from an area (rows) to an area (columns). These rows sum to 100% of fish and are color coded according to the fraction going to each area (column).



# Fit to stock-of-origin data

```{r SOO_fit_o, fig.width=7, fig.height=9,echo=FALSE}

linebar<-function(obs,obsSE,pred,age,lwd=1,pcex=1,
                  cols=c("#ff000070","#00ff0070","#0000ff70"),xlim=NA,ylim=NA,allobs,allpred,type="untransformed"){

  logit<-function(x)exp(x)/(1+exp(x))

  if(is.na(xlim[1])){
    UB<--100000
    LB<-100000
    for(i in 1:length(obs)){
      temp<-qnorm(c(0.05,0.5,0.95),obs[i],obsSE[i])
      if(max(temp)>UB)UB<-max(temp)
      if(min(temp)<LB)LB<-min(temp)
    }
  }else{
    LB<-xlim[1]
    UB<-xlim[2]
  }

  if(is.na(ylim[1]))ylim=range(pred)

  plot(c(LB,UB),ylim,col="white",xlab="",ylab="",main="")
  if(type=="untransformed"){
    points(allobs,allpred,pch=19,cex=pcex*0.9,col="#99999950")
  }else if(type=="logit"){
    points(logit(allobs),logit(allpred),pch=19,cex=pcex*0.9,col="#99999950")
    pred<-logit(pred)
  }else if(type=="log"){
    points(log(allobs+0.0001),log(allpred+0.0001),pch=19,cex=pcex*0.9,col="#99999950")
    pred<-log(obs+0.0001)
  }
  
  abline(v=0,lty=2,col='light grey')
  abline(h=0,lty=2,col='light grey')
  if(type=="logit"){
    abline(v=1,lty=2,col='light grey')
    abline(h=1,lty=2,col='light grey')
  }
  
  lines(c(-100,100),c(-100,100),col='light grey')
  for(i in 1:length(obs)){
    pointy<-qnorm(c(0.05,0.5,0.95),obs[i],obsSE[i])
    if(type=="logit")pointy<-logit(pointy)
    if(type=="log")pointy<-log(pointy)
    lines(pointy[c(1,3)],rep(pred[i],2),col=cols[age[i]],lwd=lwd)
    points(pointy[2],pred[i],pch=19,cex=pcex,col=cols[age[i]])

  }
}

par(mfrow=c(nr-2,ns),mai=c(0.25,0.35,0.1,0.01),omi=c(0.4,0.6,0.3,0.05))

subyrnams=c("Jan-Mar","Apr-Jun","Jul-Sept","Oct-Dec")
areanams=OMI@areanams
firstplot<-0
typeind<-OMI@SOOobs[,8]==1
SOOobs<-OMI@SOOobs[typeind,]
SOOpred<-out$SOOpred[typeind]
allpred<-out$SOOpred[typeind]
allobs<-OMI@SOOobs[typeind,6]

for(rr in 2:(out$nr-1)){
  for(ss in 1:out$ns){
    ind<-SOOobs[,4]==rr&SOOobs[,3]==ss
    temp<-matrix(SOOobs[ind,],nrow=sum(ind))
    pred<-SOOpred[ind]
    if(sum(ind)==0){
      plot(1,1,col="white",axes=F,xlab="",ylab="",main="")
      
      firstplot<-firstplot+1
      if(firstplot==1)legend('center',legend=c("Ages 1-4","Ages 5-8","Ages 9+"),text.col=c('red','green','blue'))
    }  
    if(sum(ind)>0)linebar(temp[,6],temp[,7],pred,temp[,1],xlim=c(-7,7),ylim=c(-5,7.5),allobs=allobs,allpred=allpred)
    if(ss==1)mtext(areanams[rr],2,line=2.75)
    if(rr==2)mtext(subyrnams[ss],3,line=0.5)
  }
}
mtext("Observed logit probability Eastern",1,line=0.8,outer=T)
mtext("Predicted logit probability Eastern",2,line=2.5,outer=T)


```

Figure 14a. The model fit to the observed probability eastern stock-of-origin data derived from otolith microchemistry data. These data were calculated by the mixture modelling approach of Carruthers and Butterworth (2018) where the 'signature' of Western (GOM) and Eastern (Med) assignment data are used to derive an estimate of the stock composition of fish for a given age class, in a given year, area and season. This interpretation of the assignment data provides a measure of uncertainty in probability eastern estimates. The horizontal lines represent the 90% confidence interval for the observed data. Since we present maximum likelihood estimates of the model predictions, there is a single model prediction (y-axis). Grey points represent all ofhte stock-or-origin data and are the same in each plot. The colored points and bars are specific to each panel. Green-red-blue colors represent age classes.  

```{r SOO_fit_o_logit, fig.width=7, fig.height=9,echo=FALSE}

par(mfrow=c(nr-2,ns),mai=c(0.25,0.35,0.1,0.01),omi=c(0.4,0.6,0.3,0.05))
firstplot<-0

for(rr in 2:(out$nr-1)){
  for(ss in 1:out$ns){
    ind<-SOOobs[,4]==rr&SOOobs[,3]==ss
    temp<-matrix(SOOobs[ind,],nrow=sum(ind))
    pred<-SOOpred[ind]
    if(sum(ind)==0){
      plot(1,1,col="white",axes=F,xlab="",ylab="",main="")
      
      firstplot<-firstplot+1
      if(firstplot==1)legend('center',legend=c("Ages 1-4","Ages 5-8","Ages 9+"),text.col=c('red','green','blue'))
    }  
    if(sum(ind)>0)linebar(temp[,6],temp[,7],pred,temp[,1],xlim=c(0,1),ylim=c(0,1),allobs=allobs,allpred=allpred,type="logit")
    if(ss==1)mtext(areanams[rr],2,line=2.75)
    if(rr==2)mtext(subyrnams[ss],3,line=0.5)
  }
}
mtext("Observed probability Eastern",1,line=0.8,outer=T)
mtext("Predicted probability Eastern",2,line=2.5,outer=T)

```

Figure 14b. As Figure 14a but expressed as percentages. 



```{r SOO_fit_g, fig.width=7, fig.height=9,echo=FALSE}

par(mfrow=c(nr-2,ns),mai=c(0.25,0.35,0.1,0.01),omi=c(0.4,0.6,0.3,0.05))
firstplot<-0
typeind<-OMI@SOOobs[,8]==2
SOOobs<-OMI@SOOobs[typeind,]
SOOpred<-out$SOOpred[typeind]
allpred<-out$SOOpred[typeind]
allobs<-OMI@SOOobs[typeind,6]

for(rr in 2:(out$nr-1)){
  for(ss in 1:out$ns){
    ind<-SOOobs[,4]==rr&SOOobs[,3]==ss
    temp<-matrix(SOOobs[ind,],nrow=sum(ind))
    pred<-SOOpred[ind]
    if(sum(ind)==0){
      plot(1,1,col="white",axes=F,xlab="",ylab="",main="")
      
      firstplot<-firstplot+1
      if(firstplot==1)legend('center',legend=c("Ages 1-4","Ages 5-8","Ages 9+"),text.col=c('red','green','blue'))
    }  
    if(sum(ind)>0)linebar(temp[,6],temp[,7],pred,temp[,1],xlim=c(-7,7),ylim=c(-5,7.5),allobs=allobs,allpred=allpred)
    if(ss==1)mtext(areanams[rr],2,line=2.75)
    if(rr==2)mtext(subyrnams[ss],3,line=0.5)
  }
}
mtext("Observed log probability Eastern",1,line=0.8,outer=T)
mtext("Predicted log probability Eastern",2,line=2.5,outer=T)

```

Figure 14c. As figure 14a but for the genetics stock-of-origin data. 


```{r SOO_fit_g_logit, fig.width=7, fig.height=9,echo=FALSE}

par(mfrow=c(nr-2,ns),mai=c(0.25,0.35,0.1,0.01),omi=c(0.4,0.6,0.3,0.05))
firstplot<-0

for(rr in 2:(out$nr-1)){
  for(ss in 1:out$ns){
    ind<-SOOobs[,4]==rr&SOOobs[,3]==ss
    temp<-matrix(SOOobs[ind,],nrow=sum(ind))
    pred<-SOOpred[ind]
    if(sum(ind)==0){
      plot(1,1,col="white",axes=F,xlab="",ylab="",main="")
      
      firstplot<-firstplot+1
      if(firstplot==1)legend('center',legend=c("Ages 1-4","Ages 5-8","Ages 9+"),text.col=c('red','green','blue'))
    }  
    if(sum(ind)>0)linebar(temp[,6],temp[,7],pred,temp[,1],xlim=c(0,1),ylim=c(0,1),allobs=allobs,allpred=allpred,type="logit")
    if(ss==1)mtext(areanams[rr],2,line=2.75)
    if(rr==2)mtext(subyrnams[ss],3,line=0.5)
  }
}
mtext("Observed probability Eastern",1,line=0.8,outer=T)
mtext("Predicted probability Eastern",2,line=2.5,outer=T)

```

Figure 14d. As figure 14b but for the genetics stock-of-origin data. 


# Fit to E-tag transitions

```{r etag_fit_log, fig.width=7, fig.height=9,echo=FALSE}

par(mfrow=c(nr,ns),mai=c(0.25,0.3,0.01,0.01),omi=c(0.4,0.6,0.3,0.05))

subyrnams=c("Jan-Mar","Apr-Jun","Jul-Sept","Oct-Dec")
areanams=OMI@areanams
firstplot=0
cexy<-0.5+(OMI@PSAT[,7]^0.5)*0.5
cols<-c("#ff000070","#0000ff70")
ticky<-seq(-4,0,length.out=6)
for(rr in 1:out$nr){
  for(ss in 1:out$ns){
    ind<-OMI@PSAT[,6]==rr&OMI@PSAT[,3]==ss
    temp<-matrix(OMI@PSAT[ind,],nrow=sum(ind))
    pred<-out$PSATpred[ind]
    if(sum(ind)==0){
      plot(1,1,col="white",axes=F,xlab="",ylab="",main="")
      if(rr==3&ss==1){
        legend('left',legend=c("East","West"),text.col=c('red','blue'),bty='n')
        legend('right',legend=c("n=1","n=10","n=20"),col='grey',pch=19,pt.cex=0.5+0.5*(c(1,10,50)^0.5),bty='n')
      }
    }  
    if(sum(ind)>0){
      plot(c(-4,0.05),c(-4,0.05),axes=F,xlab="",ylab="",main="",col='white')
      axis(1,ticky,ticky,cex.axis=0.9)
      axis(2,ticky,ticky,cex.axis=0.9)
      polygon(c(0,0,1,1),c(0,1,1,0),border='lightgrey')
      lines(c(-1000,1),c(-1000,1),col='light grey')
      points(log(temp[,8]),log(pred),cex=cexy,col=cols[temp[,1]],pch=19)
      #if(sum(pred>0.2)==0)firstplot<-firstplot+1
      
    }
    if(ss==1)mtext(areanams[rr],2,line=2.75)
    if(rr==1)mtext(subyrnams[ss],3,line=0.5)
  }
}
mtext("Observed log fraction of tags moving to area",1,line=0.8,outer=T)
mtext("Predicted log fraction of tags moving to area",2,line=2.5,outer=T)

```

Figure 15a. The model fit to the observed log fractions of tags moving to the various areas by season. Red / blue points represent observed fraction of fish moving to an area of known eastern / western origin, respectively. The size of the bubble represents the number of tags moving. Although these plots summarize tagging transition data by area and season, these data are in fact disaggregated into strata by: area moving from (7 areas), area moving to (7 areas), season (4 quarters) and age class (3 age classes).     


```{r etag_fit, fig.width=7, fig.height=9,echo=FALSE}

par(mfrow=c(nr,ns),mai=c(0.25,0.3,0.01,0.01),omi=c(0.4,0.6,0.3,0.05))

subyrnams=c("Jan-Mar","Apr-Jun","Jul-Sept","Oct-Dec")
areanams=OMI@areanams
firstplot=0
cexy<-0.5+(OMI@PSAT[,7]^0.5)*0.5
cols<-c("#ff000070","#0000ff70")
ticky<-seq(0,1,length.out=6)
for(rr in 1:out$nr){
  for(ss in 1:out$ns){
    ind<-OMI@PSAT[,6]==rr&OMI@PSAT[,3]==ss
    temp<-matrix(OMI@PSAT[ind,],nrow=sum(ind))
    pred<-out$PSATpred[ind]
    if(sum(ind)==0){
      plot(1,1,col="white",axes=F,xlab="",ylab="",main="")
      if(rr==3&ss==1){
        legend('left',legend=c("East","West"),text.col=c('red','blue'),bty='n')
        legend('right',legend=c("n=1","n=10","n=20"),col='grey',pch=19,pt.cex=0.5+0.5*(c(1,10,50)^0.5),bty='n')
      }
    }  
    if(sum(ind)>0){
      plot(c(-0.05,1.05),c(-0.05,1.05),axes=F,xlab="",ylab="",main="",col='white')
      axis(1,ticky,ticky,cex.axis=0.9)
      axis(2,ticky,ticky,cex.axis=0.9)
      polygon(c(0,0,1,1),c(0,1,1,0),border='lightgrey')
      lines(c(-1,1),c(-1,1),col='light grey')
      points(temp[,8],pred,cex=cexy,col=cols[temp[,1]],pch=19)
      #if(sum(pred>0.2)==0)firstplot<-firstplot+1
     
    }
    if(ss==1)mtext(areanams[rr],2,line=2.75)
    if(rr==1)mtext(subyrnams[ss],3,line=0.5)
  }
}
mtext("Observed fraction of tags moving to area",1,line=0.8,outer=T)
mtext("Predicted fraction of tags moving to area",2,line=2.5,outer=T)

```

Figure 15b. As Figure 15a but showing real fractions (not log transformed)



# Stock mixing 

```{r mixing, fig.width=8, fig.height=4,echo=FALSE}

par(mfrow=c(1,3),mai=c(0.8,0.8,0.1,0.15),omi=c(0.1,0.1,0.4,0.01))

plot(yrs,F_EinW,col='white',type='l',ylim=c(0,max(F_EinW,F_WinE)),xlab="Year",ylab="Fraction of Stock Biomass",yaxs='i')
abline(h=seq(0,1,by=0.05),col='light grey')
lines(yrs,F_EinW,col='red',type='l')
lines(yrs,F_WinE,col='blue',type='l')
legend('left',legend=c("Eastern Biomass in West Area","Western Biomass in East Area"),text.col=c('red','blue'),cex=0.8,bty='n')

plot(yrs,F_W_E,col='white',type='l',ylim=c(0,max(F_W_E,F_E_W)),xlab="Year",ylab="Fraction of Area Biomass",yaxs='i')
abline(h=seq(0,1,by=0.1),col='light grey')
lines(yrs,F_W_E,col='blue',type='l')
lines(yrs,F_E_W,col='red',type='l')
legend('left',legend=c("West Area Biomass that is Eastern Stock","East Area Biomass that is Western Stock"),cex=0.8,text.col=c('red','blue'),bty='n')

plot(yrs,A_WinE*1E-6,col='white',type='l',ylim=c(0,max(A_WinE,A_EinW)*1E-6),xlab="Year",ylab="Absolute Stock Biomass in Opposite Area (kt)",yaxs='i')
lines(yrs,A_WinE*1E-6,col='blue',type='l')
lines(yrs,A_EinW*1E-6,col='red',type='l')
legend('left',legend=c("E. Stock Biomass in W. Area","W. Stock Biomass in E. Area"), cex=0.8, text.col=c('red','blue'), bty='n')

```

Figure 16. Predicted stock mixing (averaged over seasons, summed over areas). On the left is the degree to which each stock has been distributed in the opposite ocean area over time. In the middle is the fraction of Eastern Stock biomass found in the East/West areas over time (stock composition over time). The right hand plot is the absolute magnitude of total biomass of each stock found in the opposite area over time. 


```{r mixingbystrata, fig.width=7, fig.height=9.5,echo=FALSE}

subyrnams=c("Jan-Mar","Apr-Jun","Jul-Sept","Oct-Dec")
areanams=OMI@areanams
plab<-c(paste0("(",letters[1:26],")"),paste0("(",paste0(letters[1:26],letters[1:26]),")"))
par(mfrow=c(nr,ns),mai=c(0.2,0.2,0.1,0.15),omi=c(0.6,0.8,0.4,0.01))
l<-0
xs<-seq(1950,2020,length.out=8)
ys<-seq(0,100,length.out=6)

for(rr in 1:nr){
  for(ss in 1:ns){
    l<-l+1
    FracE<-RAIpP[rr,ss,,1]/apply(RAIpP[rr,ss,,],1,sum)*100
    plot(yrs,FracE,type="l",ylim=c(0,100),xlab="",ylab="",yaxs="i",col="white",axes=F)
    abline(h=ys,col="light grey")
    abline(h=c(50,100),col="black")
    lines(yrs,FracE,col="red")
    points(yrs,FracE,col="red",pch=19,cex=0.8)
    if(rr==nr)axis(1,xs,xs)
    if(rr<nr)axis(1,xs,NA)
    if(ss==1)axis(2,ys,ys)
    if(ss<(ns+1))axis(2,ys,NA)
    if(ss==1)mtext(areanams[rr],2,line=2.75)
    if(rr==1)mtext(subyrnams[ss],3,line=0.75)

    mtext(plab[l],3,adj=0.02,line=0.25,cex=0.7)
  }
}

mtext("Year",1,outer=T,line=1.5,font=2)
mtext("Fraction of biomass that is Eastern origin (%)",2,outer=T,line=3.5,font=2)

```

Figure 17a. Predicted stock mixing by year, season and area. The red line is the fraction (%) of stock biomass that is Eastern. 

```{r SSBdistbystrataE, fig.width=7, fig.height=9.5,echo=FALSE}

stk<-1
subyrnams=c("Jan-Mar","Apr-Jun","Jul-Sept","Oct-Dec")
areanams=OMI@areanams
plab<-c(paste0("(",letters[1:26],")"),paste0("(",paste0(letters[1:26],letters[1:26]),")"))
par(mfrow=c(nr,ns),mai=c(0.2,0.2,0.1,0.15),omi=c(0.6,0.8,0.4,0.01))
l<-0
xs<-seq(1950,2020,length.out=8)
ys<-seq(0,100,length.out=6)

maxfrac<-0
for(rr in 1:nr){
  for(ss in 1:ns){
    l<-l+1
    Bf<-RAIpP[rr,ss,,stk]/apply(RAIpP[,ss,,stk],2,sum)*100
    maxfrac<-max(maxfrac,Bf)
}}

for(rr in 1:nr){
  for(ss in 1:ns){
    l<-l+1
    Bf2<-SSBmu2[rr,ss,,stk]/apply(SSBmu2[,ss,,stk],2,sum)*100
    Bf<-RAIpP[rr,ss,,stk]/apply(RAIpP[,ss,,stk],2,sum)*100
    plot(yrs,Bf,type="l",ylim=c(0,maxfrac),xlab="",ylab="",yaxs="i",col="white",axes=F)
   
    abline(h=ys,col="light grey")
    abline(h=c(50,100),col="black")
    lines(yrs,Bf,col="#ff000070",lwd=2)
    lines(yrs,Bf2,col="#0000ff70",lwd=2)
    
    #points(yrs,Bf,col="red",pch=19,cex=0.8)
    if(rr==nr)axis(1,xs,xs)
    if(rr<nr)axis(1,xs,NA)
    if(ss==1)axis(2,ys,ys)
    if(ss<(ns+1))axis(2,ys,NA)
    if(ss==1)mtext(areanams[rr],2,line=2.75)
    if(rr==1)mtext(subyrnams[ss],3,line=0.75)

    mtext(plab[l],3,adj=0.02,line=0.25,cex=0.7)
  }
}

mtext("Year",1,outer=T,line=1.5,font=2)
mtext("Fraction of biomass",2,outer=T,line=3.5,font=2)

```

Figure 17b. Predicted spatial distribution of Eastern stock biomass by year and season. The red line is the fraction (%) of stock biomass found in each area, blue lines are spawning stock biomass.  


```{r SSBdistbystrataW, fig.width=7, fig.height=9.5,echo=FALSE}

stk<-2
subyrnams=c("Jan-Mar","Apr-Jun","Jul-Sept","Oct-Dec")
areanams=OMI@areanams
plab<-c(paste0("(",letters[1:26],")"),paste0("(",paste0(letters[1:26],letters[1:26]),")"))
par(mfrow=c(nr,ns),mai=c(0.2,0.2,0.1,0.15),omi=c(0.6,0.8,0.4,0.01))
l<-0
xs<-seq(1950,2020,length.out=8)
ys<-seq(0,100,length.out=6)

maxfrac<-0
for(rr in 1:nr){
  for(ss in 1:ns){
    l<-l+1
    Bf<-RAIpP[rr,ss,,stk]/apply(RAIpP[,ss,,stk],2,sum)*100
    maxfrac<-max(maxfrac,Bf)
}}

for(rr in 1:nr){
  for(ss in 1:ns){
    l<-l+1
    Bf<-RAIpP[rr,ss,,stk]/apply(RAIpP[,ss,,stk],2,sum)*100
    Bf2<-SSBmu2[rr,ss,,stk]/apply(SSBmu2[,ss,,stk],2,sum)*100
   
    plot(yrs,Bf,type="l",ylim=c(0,maxfrac),xlab="",ylab="",yaxs="i",col="white",axes=F)
    abline(h=ys,col="light grey")
    abline(h=c(50,100),col="black")
    lines(yrs,Bf,col="#ff000070",lwd=2)
    lines(yrs,Bf2,col="#0000ff70",lwd=2)
    #points(yrs,Bf,col="red",pch=19,cex=0.8)
    if(rr==nr)axis(1,xs,xs)
    if(rr<nr)axis(1,xs,NA)
    if(ss==1)axis(2,ys,ys)
    if(ss<(ns+1))axis(2,ys,NA)
    if(ss==1)mtext(areanams[rr],2,line=2.75)
    if(rr==1)mtext(subyrnams[ss],3,line=0.75)

    mtext(plab[l],3,adj=0.02,line=0.25,cex=0.7)
  }
}

mtext("Year",1,outer=T,line=1.5,font=2)
mtext("Fraction of biomass",2,outer=T,line=3.5,font=2)

```

Figure 17c. Predicted spatial distribution of Western stock biomass by year and season. The red line is the fraction (%) of stock biomass found in each area,blue lines are spawning stock biomass.  

# Seasonal / spatial priors

```{r seasonaltrend, fig.width=7, fig.height=3,echo=FALSE}

if(!is.null(OMI@SpatPr)){

   ni<-max(OMI@SpatPr[,4]) 
   par(mfrow=c(ceiling(ni/2),2),mai=c(0.3,0.4,0.01,0.01),omi=c(0.8,0.8,0.01,0.01))

   for(i in 1:ni){
     
     daty<-OMI@SpatPr[OMI@SpatPr[,4]==i,]
     
     pred<-out$SPpred_vec[OMI@SpatPr[,4]==i]
     #pred<-pred*(mean(daty[,5])/mean(pred))
     plot(daty[,2],daty[,5],ylim=c(0,max(daty[,5])),yaxs='i',xlab="",ylab="")
     lines(daty[,2],pred,col='blue')
     legend('topright',legend=OMI@areanams[daty[1,3]],text.col='blue',bty='n')
      
   }
   mtext("Quarter",1,line=1.8,outer=T)
   mtext("Index",2,line=1.8,outer=T)
  
}else{
  
  plot(1,1,col="white",axes=F)
  legend('centre',legend="no spatial priors")
  
}

```

Figure 17d. Estimated seasonal distribution relative to prior specification.   
